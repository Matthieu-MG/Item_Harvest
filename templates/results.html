{% extends 'layout.html' %}

{% block title %}
    Results
{% endblock %}

{% block main %}
    
    <script>

        // Stores all the items checked by user
        items_added = []

        // Sends all of the items in items_added to server and redirects to /wishlist route
        function addToWishlist(){
            $.ajax({
                url: '/add',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ 'wishlist': items_added}),
            }).done(function(data){
                window.location.href = '/wishlist'
            })
        }
        
        function add_remove(checkbox){

            // Gets item's id
            let item = checkbox.value
            if (checkbox.checked){

                console.log("adding to array")
                // adds item to end of array
                items_added.push(item)
                console.log(items_added)

            }
            else{

                // Gets index of item's id in array
                const index = items_added.indexOf(item)

                // If id is in items_added array, remove it
                if (index > -1){

                    // The second parameter means remove only one
                    items_added.splice(index, 1)
                }
                console.log("unchecked")
            }
        }

        function directAdd(id, btn_id)
        {
            let item = document.getElementById(id)
            let button = document.getElementById(btn_id)

            $.ajax({
                url: '/directAdd',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ 'item': item.value })
            }).done(function(){
                button.disabled = true;
                button.innerHTML = 'Added';
            })
        }
    </script>

    <div class="center lightpadding">
        <form action="/searchResults" method="get">
            <div>
                <input autocomplete="off" class="mx-auto w-auto text form-control-lg" id="searchInput" name="query" placeholder="Search" type="text">
                <button class="invisble-button" hidden type="submit">Confirm</button>
            </div>
        </form>
    </div>

    <div class="container chop-chop">
        {% if s_results|length < 1 %}
        <div class="alert alert-warning text-center" role="alert">
            No results found for your query !
        </div>
        {% else %}
        <div class="alert alert-success text-center" role="alert">
            Try searching with more keywords, if you are searching for something specifically.
        </div>
        {% endif %}
    </div>

    {% if s_results|length > 0 %}
    <div class="dropdown center">
        <button class="btn btn-outline-info dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">filters</button>
        <ul class="dropdown-menu">
            <form class="dropdown-item" action="/searchResults" method="post">

                <li class="dropdown-item">
                        <input type="radio" class="btn btn-outline-warning" value="{{ s_results }}" name="sortPrice" placeholder="Sort Price">
                        <span>Sort Price</span>
                </li>

                <li class="dropdown-item">
                    <input type="radio" value="ascending" name="sortType"><span>Ascending</span>
                </li>

                <li class="dropdown-item">                
                    <input type="radio" value="descending" name="sortType"><span>Descending</span>
                </li>

                <li class="dropdown-item">
                    <button class="btn btn-warning" type="submit">Filter</button>
                </li> 

            </form>
        </ul>
    </div>
    {% endif %}

    <div class="container">
        <div class="row gy-3 my-3">
            {% for item in s_results%}
                
            <div class="col-md-3">
                <div class="card h-100">
                    <img class="card-img-top" src="{{ item.image }}" alt="Card image cap">
                    <div class="card-body">
                      <h5 class="card-title">{{ item.title }}</h5>
                      <p class="card-text">
                        <input type="hidden" id="{{ item.link }}" value='{"title": "{{ item.title }}", "price": {{ item.price }}, "link": "{{ item.link }}", "retailer" : "{{ item.retailer}}", "img" : "{{ item.image }}"}' onchange="add_remove(this)">
                        <button class="btn btn-primary btn-sm" id="button{{ item.link }}" onclick="directAdd('{{ item.link }}', id)">Direct Add</button>
                      </p>
                      <p class="card-text price">{{ currency }} 
                        {% if item.local_price %}
                            {{ item.local_price | formatPrice }}</p>
                        {% else %}
                            {{ item.price }}
                        {% endif %}
                      <p class="card-text">{{ item.retailer }}</p>
                      <a href="{{ item.link }}" class="btn btn-primary">Link</a>
                    </div>
                </div>
            </div>

            {% endfor %}
        </div>
    </div>
{% endblock %}