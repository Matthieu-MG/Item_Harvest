{% extends 'layout.html' %}

{% block title %}
    Results
{% endblock %}

{% block main %}
    
    <script>

        // Stores all the items checked by user
        items_added = []

        // Sends all of the items in items_added to server and redirects to /wishlist route
        function addToWishlist(){
            $.ajax({
                url: '/add',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ 'wishlist': items_added}),
            }).done(function(data){
                window.location.href = '/wishlist'
            })
        }
        
        function add_remove(checkbox){

            // Gets item's id
            let item = checkbox.value
            if (checkbox.checked){

                console.log("adding to array")
                // adds item to end of array
                items_added.push(item)
                console.log(items_added)

            }
            else{

                // Gets index of item's id in array
                const index = items_added.indexOf(item)

                // If id is in items_added array, remove it
                if (index > -1){

                    // The second parameter means remove only one
                    items_added.splice(index, 1)
                }
                console.log("unchecked")
            }
        }

        function directAdd(id, btn_id)
        {
            let item = document.getElementById(id)
            let button = document.getElementById(btn_id)

            $.ajax({
                url: '/directAdd',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ 'item': item.value })
            }).done(function(){
                button.disabled = true;
                button.innerHTML = 'Added';
            })
        }
    </script>

    <div class="center lightpadding">
        <button class="btn btn-success" onclick="addToWishlist()">
            Add To Wishlist
        </button>
    </div>

    <div class="container">
        <div class="row gy-3 my-3">
            {% for item in s_results%}
                
            <div class="col-md-3">
                <div class="card h-100">
                    <img class="card-img-top" src="{{ item.image }}" alt="Card image cap">
                    <div class="card-body">
                      <h5 class="card-title">{{ item.title }}</h5>
                      <p class="card-text">
                        <input type="checkbox" id="{{ item.link }}" value='{"title": "{{ item.title }}", "price": {{ item.price }}, "link": "{{ item.link }}", "retailer" : "{{ item.retailer}}", "img" : "{{ item.image }}"}' onchange="add_remove(this)">
                        <button class="btn btn-primary btn-sm" id="button{{ item.link }}" onclick="directAdd('{{ item.link }}', id)">Direct Add</button>
                      </p>
                      <p class="card-text">{{ item.retailer }} : {{ item.price }}</p>
                      <a href="{{ item.link }}" class="btn btn-primary">Link</a>
                    </div>
                </div>
            </div>

            {% endfor %}
        </div>
    </div>
{% endblock %}